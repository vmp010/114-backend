# =============================================================================
# GitHub Actions - è‡ªå‹•åŒ–éƒ¨ç½²å·¥ä½œæµç¨‹
# GitHub Actions - Automated Deployment Workflow
# =============================================================================
# é€™å€‹æª”æ¡ˆå‘Šè¨´ GitHubï¼š
# This file tells GitHub:
# ã€Œæ¯ç•¶æœ‰äºº push ç¨‹å¼ç¢¼åˆ° main åˆ†æ”¯ï¼Œå°±è‡ªå‹•åŸ·è¡Œä»¥ä¸‹å‹•ä½œã€
# "Whenever someone pushes code to the main branch, automatically run these actions"
#
# ä½ å¯ä»¥æƒ³åƒæˆï¼šGitHub é€ä½ ä¸€å°å…è²»çš„è‡¨æ™‚é›»è…¦
# Think of it as: GitHub gives you a free temporary computer
# å¹«ä½ è·‘æ¸¬è©¦ã€build imageã€éƒ¨ç½²åˆ°ä¼ºæœå™¨
# to run tests, build images, and deploy to servers
# =============================================================================

# å·¥ä½œæµç¨‹çš„åç¨±ï¼ˆæœƒé¡¯ç¤ºåœ¨ GitHub Actions é é¢ï¼‰
# Workflow name (shown on GitHub Actions page)
name: Deploy to Render

# -----------------------------------------------------------------------------
# è§¸ç™¼æ¢ä»¶ï¼šä»€éº¼æ™‚å€™åŸ·è¡Œé€™å€‹å·¥ä½œæµç¨‹ï¼Ÿ
# Trigger: When should this workflow run?
# -----------------------------------------------------------------------------
on:
  # ç•¶ push åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
  # Trigger when pushing to main branch
  push:
    branches:
      - main
  
  # ä¹Ÿå¯ä»¥æ‰‹å‹•è§¸ç™¼ï¼ˆåœ¨ GitHub Actions é é¢é»æŒ‰éˆ•ï¼‰
  # Can also be triggered manually (click button on GitHub Actions page)
  workflow_dispatch:

# -----------------------------------------------------------------------------
# å®šç¾©å·¥ä½œï¼ˆJobsï¼‰
# Define Jobs
# -----------------------------------------------------------------------------
# ä¸€å€‹ workflow å¯ä»¥æœ‰å¤šå€‹ jobs
# A workflow can have multiple jobs
# æ¯å€‹ job éƒ½åœ¨ç¨ç«‹çš„è™›æ“¬æ©Ÿå™¨ä¸ŠåŸ·è¡Œ
# Each job runs on its own virtual machine
# -----------------------------------------------------------------------------
jobs:
  # ---------------------------------------------------------------------------
  # Job 1: æ¸¬è©¦ç¨‹å¼ç¢¼ / Test Code
  # ---------------------------------------------------------------------------
  test:
    name: ğŸ§ª Run Tests

    # åœ¨ä»€éº¼ä½œæ¥­ç³»çµ±ä¸ŠåŸ·è¡Œï¼Ÿ
    # Which operating system to run on?
    # ubuntu-latest = æœ€æ–°ç‰ˆ Ubuntu Linux
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: æŠŠç¨‹å¼ç¢¼ä¸‹è¼‰åˆ°é€™å°è™›æ“¬æ©Ÿ
      # Download the code to this virtual machine
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # Step 2: å®‰è£ Python / Install Python
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      # Step 3: å®‰è£ä¾è³´å¥—ä»¶ / Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Step 4: åŸ·è¡Œæ¸¬è©¦ / Run tests
      # æ¸¬è©¦ FastAPI æ¨¡çµ„æ˜¯å¦èƒ½æ­£ç¢º import
      # Test if FastAPI modules can be imported correctly
      - name: âœ… Run basic tests
        run: |
          python -c "from main import app; print('âœ… FastAPI app import OK!')"
          python -c "from google_oauth import verify_google_id_token; print('âœ… OAuth module OK!')"
          python -c "from auth_utils import create_access_token; print('âœ… Auth module OK!')"

  # ---------------------------------------------------------------------------
  # Job 2: å»ºç«‹ Docker Image / Build Docker Image
  # ---------------------------------------------------------------------------
  build:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    
    # é€™å€‹ job è¦ç­‰ test job æˆåŠŸå¾Œæ‰åŸ·è¡Œ
    # This job waits for the test job to succeed
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # æ¸¬è©¦ Dockerfile æ˜¯å¦èƒ½æˆåŠŸ build
      # Test if Dockerfile can build successfully
      - name: ğŸ”¨ Build Docker image
        run: |
          docker build -t my-fastapi-app .
          echo "âœ… Docker build successful!"
      
      # æ¸¬è©¦ container æ˜¯å¦èƒ½æ­£å¸¸å•Ÿå‹•
      # Test if container can start normally
      - name: ğŸ§ª Test Docker container
        run: |
          # åœ¨èƒŒæ™¯å•Ÿå‹• container / Start container in background
          docker run -d -p 8000:8000 --name test-container my-fastapi-app
          
          # ç­‰å¾…æœå‹™å•Ÿå‹• / Wait for service to start
          sleep 5
          
          # æ¸¬è©¦ API æ˜¯å¦å›æ‡‰ / Test if API responds
          curl -f http://localhost:8000/ || exit 1
          echo "âœ… Container is running!"
          
          # æ¸…ç† / Cleanup
          docker stop test-container

  # ---------------------------------------------------------------------------
  # Job 3: éƒ¨ç½²åˆ° Render / Deploy to Render
  # ---------------------------------------------------------------------------
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    
    # ç­‰ build job æˆåŠŸå¾Œæ‰åŸ·è¡Œ
    # Wait for build job to succeed
    needs: build
    
    steps:
      # ä½¿ç”¨ Render Deploy Hookï¼ˆæœ€ç°¡å–®ï¼ï¼‰
      # Use Render Deploy Hook (easiest method!)
      # 
      # ğŸ¯ TODOï¼šè¨­å®šå®Œ Render å¾Œï¼ŒæŠŠ Deploy Hook URL å­˜åˆ° GitHub Secrets
      #    After setting up Render, save Deploy Hook URL to GitHub Secrets
      #    
      #    æ­¥é©Ÿ Stepsï¼š
      #    1. åˆ° Render Dashboard â†’ ä½ çš„æœå‹™ â†’ Settings â†’ Deploy Hook
      #       Go to Render Dashboard â†’ Your service â†’ Settings â†’ Deploy Hook
      #    2. è¤‡è£½ URL / Copy URL
      #    3. åˆ° GitHub Repo â†’ Settings â†’ Secrets and variables â†’ Actions
      #    4. æ–°å¢ secret / Add new secretï¼šRENDER_DEPLOY_HOOK_URL
      - name: ğŸ”” Trigger Render Deploy
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
            echo "âœ… Deploy triggered!"
          else
            echo "âš ï¸ RENDER_DEPLOY_HOOK_URL not set - skipping deploy"
            echo "ğŸ“ è«‹åƒè€ƒ docs/RENDER_SETUP.md è¨­å®š"
            echo "ğŸ“ See docs/RENDER_SETUP.md for setup instructions"
          fi

# =============================================================================
# ğŸ“ ç·´ç¿’é¡Œ Exercises
# =============================================================================
#
# 1. è§€å¯Ÿ GitHub Actions é é¢ï¼Œçœ‹çœ‹æ¯å€‹ step åŸ·è¡Œçš„éç¨‹
#    Observe the GitHub Actions page, watch each step's execution
#
# 2. æ•…æ„æŠŠ main.py æ”¹å£ï¼Œpush çœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼
#    Intentionally break main.py and push to see what happens
#
# 3. æ–°å¢ä¸€å€‹ step / Add a new stepï¼š
#    - name: Print Python version
#      run: python --version
#
# =============================================================================
